# How to View Test Steps for User Requirements

## Overview

When you provide a user instruction like `"Test purchase flow for '5G寬頻數據無限任用' plan"`, the system:
1. **Matches scenarios** to your requirement
2. **Generates test steps** for those scenarios
3. **Stores them in the database** as TestCase objects
4. **Executes them** (if real-time execution is enabled)

This guide shows you how to view what test steps were actually generated and performed.

---

## Method 1: View Test Steps in Log File

### For the Main Purchase Flow Scenario (REQ-F-001)

From the log file `test_four_agent_e2e_20260202_115306.log`, the test steps for the main purchase flow scenario are:

**Scenario:** `REQ-F-001 - Complete purchase flow for '5G寬頻數據無限任用' plan`  
**Test Case ID:** 363  
**Steps Generated (10 steps):**

```
1. Navigate to https://web.three.com.hk/5gbroadband/plan-monthly.html?intcmp=web_homeshortcut_5gbb_251230_nil_tc
2. Verify plan '5G寬頻數據無限任用' is visible on the plans selection page
3. Click on plan '5G寬頻數據無限任用'
4. Select contract term '12 months' from the contract term dropdown or options
5. Verify displayed price matches the expected price for '5G寬頻數據無限任用' 12 months plan
6. Click button labeled '立即登記'
7. Enter valid user details: fill in name, phone number, email, and any required fields
8. Submit the purchase form
9. Verify the system processes the purchase successfully
10. Verify confirmation message is displayed containing plan details for '5G寬頻數據無限任用'
```

### Finding Steps in Log File

Search for:
```bash
grep -A 20 "Test case 1 steps" test_four_agent_e2e_20260202_115306.log
```

Or look for:
- `"Test case 1 steps:"` - Shows the stored test steps
- `"Generated.*steps"` - Shows steps generated by EvolutionAgent
- `"_convert_scenario_to_steps: Generated"` - Shows steps generated by AnalysisAgent for execution

---

## Method 2: Query Database Directly

### Using Python Script

Create a script `view_test_steps.py`:

```python
"""View test steps for user-requirement scenarios"""
import sys
from pathlib import Path

# Add backend to path
backend_path = Path(__file__).parent.parent
sys.path.insert(0, str(backend_path))

from app.db.session import SessionLocal
from app.models.test_case import TestCase
import json

def view_user_requirement_steps():
    """View test steps for scenarios matching user requirements"""
    db = SessionLocal()
    try:
        # Query test cases with user-requirement tag
        # Note: tags are stored as JSON, so we need to query properly
        test_cases = db.query(TestCase).all()
        
        print("="*80)
        print("Test Cases Matching User Requirement: 'purchase flow for 5G寬頻數據無限任用 plan'")
        print("="*80)
        
        for tc in test_cases:
            # Check if title contains the plan name or purchase flow
            title_lower = tc.title.lower()
            if "5g寬頻數據無限任用" in title_lower or "purchase flow" in title_lower:
                print(f"\n{'='*80}")
                print(f"Test Case ID: {tc.id}")
                print(f"Title: {tc.title}")
                print(f"Scenario ID: {tc.test_metadata.get('scenario_id', 'N/A') if isinstance(tc.test_metadata, dict) else 'N/A'}")
                print(f"Priority: {tc.priority.value if hasattr(tc.priority, 'value') else tc.priority}")
                print(f"\nTest Steps ({len(tc.steps) if isinstance(tc.steps, list) else 0}):")
                print("-"*80)
                
                if isinstance(tc.steps, list):
                    for idx, step in enumerate(tc.steps, 1):
                        print(f"{idx}. {step}")
                else:
                    print(f"Steps: {tc.steps}")
                
                print(f"\nExpected Result: {tc.expected_result}")
                
                # Show metadata
                if tc.test_metadata:
                    metadata = tc.test_metadata if isinstance(tc.test_metadata, dict) else json.loads(tc.test_metadata)
                    print(f"\nMetadata:")
                    print(f"  - Generation ID: {metadata.get('generation_id', 'N/A')}")
                    print(f"  - RPN: {metadata.get('rpn', 'N/A')}")
                    print(f"  - Scenario Type: {metadata.get('scenario_type', 'N/A')}")
        
    finally:
        db.close()

if __name__ == "__main__":
    view_user_requirement_steps()
```

Run it:
```bash
cd backend
python tests/integration/view_test_steps.py
```

---

## Method 3: Compare with Original Requirements

### Your Original Detailed Requirements (from test_three_hk_real_page.py)

```python
"""
1. Navigate to the 5G broadband plan page
2. Find plan "5G寬頻數據無限任用"
3. Select contract term "48個月"
4. Verify price shows "$182"
5. Click "立即登記" to subscribe
6. Click "下一步" to proceed in the flow
"""
```

### Generated Test Steps (from log)

The system generated **10 steps** that cover your requirements:

| Your Requirement | Generated Step | Status |
|-----------------|----------------|--------|
| 1. Navigate to page | ✅ Step 1: Navigate to URL | ✅ Covered |
| 2. Find plan "5G寬頻數據無限任用" | ✅ Step 2: Verify plan is visible<br>✅ Step 3: Click on plan | ✅ Covered |
| 3. Select contract term "48個月" | ⚠️ Step 4: Select '12 months' | ⚠️ Different term |
| 4. Verify price shows "$182" | ✅ Step 5: Verify displayed price | ✅ Covered |
| 5. Click "立即登記" | ✅ Step 6: Click button '立即登記' | ✅ Covered |
| 6. Click "下一步" | ❌ Not explicitly in steps | ❌ Missing |

### Differences

1. **Contract Term:** Your requirement specified "48個月" but generated steps use "12 months"
   - **Reason:** The LLM may have chosen a different contract term based on what it found on the page
   - **Solution:** You can refine the user instruction to be more specific: `"Test purchase flow for '5G寬頻數據無限任用' plan with 48個月 contract term"`

2. **"下一步" Button:** Not explicitly in the generated steps
   - **Reason:** The generated steps focus on the main purchase flow, and "下一步" might be part of a later step
   - **Solution:** Check if it's included in step 8 "Submit the purchase form" or add it to your instruction

---

## Method 4: View Executed Steps (Real-Time Execution)

If real-time execution is enabled, you can see what steps were actually executed:

### From Log File

Search for:
```bash
grep -A 10 "Scenario REQ-F-001 executed" test_four_agent_e2e_20260202_115306.log
```

You'll see:
```
Scenario REQ-F-001 executed: 7/8 passed, success_rate=0.88, tier=hybrid
```

This means:
- **8 steps** were generated for execution
- **7 steps passed**
- **1 step failed or was skipped**
- Execution used **hybrid tier** (combination of Playwright and Stagehand AI)

### Execution Steps (from AnalysisAgent)

The log shows the steps generated for real-time execution (line 241):
```
Generated 8 steps:
1. Navigate to https://web.three.com.hk/5gbroadband/plan-monthly.html?intcmp=web_homeshortcut_5gbb_251230_nil_tc
2. Click on plan '5G寬頻數據無限任用'
3. Select contract term '12 months'
4. Verify displayed price is correct
5. Click button '立即登記'
6. Enter valid user details
7. Submit purchase form
8. Verify: System processes the purchase successfully and shows confirmation message with plan details
```

---

## Method 5: Query Database by Scenario ID

### Using SQL

```sql
-- Find test case by scenario ID
SELECT id, title, steps, expected_result, test_metadata
FROM test_cases
WHERE test_metadata->>'scenario_id' = 'REQ-F-001'
ORDER BY id DESC
LIMIT 1;
```

### Using Python

```python
from app.db.session import SessionLocal
from app.models.test_case import TestCase
import json

db = SessionLocal()
test_case = db.query(TestCase).filter(
    TestCase.test_metadata['scenario_id'].astext == 'REQ-F-001'
).order_by(TestCase.id.desc()).first()

if test_case:
    print(f"Title: {test_case.title}")
    print(f"Steps: {test_case.steps}")
```

---

## Method 6: Enhanced User Instruction for Specific Requirements

If you want the generated steps to match your original detailed requirements more closely, use a more specific instruction:

### Instead of:
```
"Test purchase flow for '5G寬頻數據無限任用' plan"
```

### Use:
```
"Test purchase flow for '5G寬頻數據無限任用' plan: 
1. Navigate to plan page
2. Find and select plan '5G寬頻數據無限任用'
3. Select contract term '48個月'
4. Verify price shows '$182'
5. Click '立即登記' button
6. Click '下一步' button to proceed"
```

This will help the LLM generate steps that more closely match your specific requirements.

---

## Summary

### Quick Reference

1. **Log File:** Search for `"Test case 1 steps"` or `"Generated.*steps"`
2. **Database:** Query `test_cases` table by `scenario_id = 'REQ-F-001'`
3. **Python Script:** Use the provided script to view all matching test cases
4. **Execution Results:** Check log for `"Scenario REQ-F-001 executed"` to see what actually ran

### Key Test Steps for Your Requirement

**Main Purchase Flow (REQ-F-001):**
- ✅ Navigate to page
- ✅ Find and click plan '5G寬頻數據無限任用'
- ⚠️ Select contract term (generated: '12 months', you wanted: '48個月')
- ✅ Verify price
- ✅ Click '立即登記'
- ❌ Click '下一步' (not explicitly in steps)

**Recommendation:** Use a more detailed user instruction to get steps that match your exact requirements.

