# Sprint 10 CI — Agent Workflow API v2
# Developer B: Frontend UI + Integration + Load Tests
#
# Triggers:
#   - Push/PR to feature/sprint10-frontend-ui
#   - Push/PR to develop
#   - Manual dispatch
#
# Jobs:
#   1. frontend-unit-tests  — Vitest (all agent-workflow __tests__)
#   2. backend-integration  — pytest (test_agent_workflow_e2e.py)
#   3. backend-load         — pytest (test_agent_workflow_load.py)
#   4. notify               — Summary comment on PRs

name: Sprint 10 — Agent Workflow Tests

on:
  push:
    branches:
      - feature/sprint10-frontend-ui
      - develop
      - main
    paths:
      - 'frontend/src/features/agent-workflow/**'
      - 'frontend/src/services/agentWorkflowService.ts'
      - 'frontend/src/services/sseService.ts'
      - 'frontend/src/types/agentWorkflow.types.ts'
      - 'backend/app/api/v2/**'
      - 'backend/app/schemas/workflow.py'
      - 'backend/tests/integration/test_agent_workflow_e2e.py'
      - 'backend/tests/load/test_agent_workflow_load.py'
      - '.github/workflows/sprint10-tests.yml'

  pull_request:
    branches:
      - develop
      - main
    paths:
      - 'frontend/src/features/agent-workflow/**'
      - 'frontend/src/services/agentWorkflowService.ts'
      - 'frontend/src/services/sseService.ts'
      - 'frontend/src/types/agentWorkflow.types.ts'
      - 'backend/app/api/v2/**'
      - 'backend/app/schemas/workflow.py'
      - 'backend/tests/integration/test_agent_workflow_e2e.py'
      - 'backend/tests/load/test_agent_workflow_load.py'
      - '.github/workflows/sprint10-tests.yml'

  workflow_dispatch:
    inputs:
      run_load_tests:
        description: 'Run load tests (may be slow in CI)'
        required: false
        default: 'true'
        type: boolean

# ---------------------------------------------------------------------------
# Concurrency — cancel stale runs on the same branch
# ---------------------------------------------------------------------------
concurrency:
  group: sprint10-${{ github.ref }}
  cancel-in-progress: true

# ---------------------------------------------------------------------------
# Default permissions
# ---------------------------------------------------------------------------
permissions:
  contents: read
  pull-requests: write

# ===========================================================================
# Jobs
# ===========================================================================

jobs:

  # -------------------------------------------------------------------------
  # Job 1: Frontend Unit Tests (Vitest)
  # -------------------------------------------------------------------------
  frontend-unit-tests:
    name: Frontend Unit Tests (Vitest)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run agent-workflow unit tests
        run: npx vitest run src/features/agent-workflow --reporter=verbose

      - name: Run service stub tests
        run: npx vitest run src/services/__tests__ --reporter=verbose

      - name: Collect coverage
        run: npx vitest run --coverage --coverage.include='src/features/agent-workflow/**' --reporter=json --outputFile=vitest-results.json
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 7

  # -------------------------------------------------------------------------
  # Job 2: Backend Integration Tests (pytest)
  # -------------------------------------------------------------------------
  backend-integration-tests:
    name: Backend Integration Tests (pytest)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: backend

    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      DATABASE_URL: sqlite:///./test_sprint10.db
      SECRET_KEY: sprint10-ci-test-secret-key-not-for-prod
      ENVIRONMENT: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx

      - name: Run agent workflow E2E integration tests
        run: |
          python -m pytest tests/integration/test_agent_workflow_e2e.py \
            -v \
            --tb=short \
            --junit-xml=test-results/integration.xml \
            -p no:warnings

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-integration-results
          path: backend/test-results/
          retention-days: 7

  # -------------------------------------------------------------------------
  # Job 3: Backend Load Tests (pytest)
  # -------------------------------------------------------------------------
  backend-load-tests:
    name: Backend Load Tests (pytest)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run load tests when explicitly triggered or on develop/main
    if: |
      github.event_name == 'workflow_dispatch' && inputs.run_load_tests == 'true'
      || github.ref == 'refs/heads/develop'
      || github.ref == 'refs/heads/main'

    defaults:
      run:
        working-directory: backend

    env:
      PYTHONPATH: ${{ github.workspace }}/backend
      DATABASE_URL: sqlite:///./test_sprint10_load.db
      SECRET_KEY: sprint10-ci-load-test-secret-key-not-for-prod
      ENVIRONMENT: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run load tests
        run: |
          python -m pytest tests/load/test_agent_workflow_load.py \
            -v \
            --tb=short \
            --junit-xml=test-results/load.xml \
            -p no:warnings \
            -s

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-load-results
          path: backend/test-results/
          retention-days: 7

  # -------------------------------------------------------------------------
  # Job 4: PR Summary Comment
  # -------------------------------------------------------------------------
  pr-summary:
    name: PR Test Summary
    runs-on: ubuntu-latest
    needs: [frontend-unit-tests, backend-integration-tests]
    if: github.event_name == 'pull_request'

    steps:
      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: coverage/frontend
        continue-on-error: true

      - name: Download backend integration results
        uses: actions/download-artifact@v4
        with:
          name: backend-integration-results
          path: results/backend
        continue-on-error: true

      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const frontendStatus = '${{ needs.frontend-unit-tests.result }}';
            const backendStatus  = '${{ needs.backend-integration-tests.result }}';

            const icon = (s) => s === 'success' ? '✅' : s === 'failure' ? '❌' : '⚠️';

            const body = [
              '## Sprint 10 — Agent Workflow Test Results',
              '',
              '| Job | Status |',
              '|-----|--------|',
              `| Frontend Unit Tests (Vitest)      | ${icon(frontendStatus)} ${frontendStatus} |`,
              `| Backend Integration Tests (pytest) | ${icon(backendStatus)} ${backendStatus} |`,
              '',
              '**Developer B — Sprint 10 Phase 2**',
              `> Commit: \`${context.sha.slice(0, 8)}\` | Branch: \`${context.ref.replace('refs/heads/', '')}\``,
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });
